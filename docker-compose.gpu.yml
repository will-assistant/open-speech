###############################################################################
# Open Speech — GPU accelerated (STT + TTS)
#
# Environment variable naming convention:
#   OS_*   — Server-level settings (port, host, SSL, rate limiting)
#   STT_*  — Speech-to-text settings (model, device, compute type)
#   TTS_*  — Text-to-speech settings (model, device, voice, speed)
#
# Old STT_PORT, STT_HOST etc. still work but are deprecated.
#
# Quick start:
#   docker compose -f docker-compose.gpu.yml up -d
#
# Requires: NVIDIA GPU + nvidia-container-toolkit
###############################################################################

services:
  open-speech:
    build:
      context: .
      dockerfile: Dockerfile
    image: jwindsor1/open-speech:latest
    container_name: open-speech
    restart: unless-stopped
    ports:
      - "${OS_PORT:-8100}:${OS_PORT:-8100}"
      - "${OS_WYOMING_PORT:-10400}:${OS_WYOMING_PORT:-10400}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    env_file:
      - path: .env
        required: false
    environment:
      # ── Server ──
      - OS_PORT=${OS_PORT:-8100}
      - OS_HOST=${OS_HOST:-0.0.0.0}
      # - STT_PORT=...  # deprecated, use OS_PORT
      # - STT_HOST=...  # deprecated, use OS_HOST
      # ── STT ──
      - STT_MODEL=${STT_MODEL:-deepdml/faster-whisper-large-v3-turbo-ct2}
      - STT_DEVICE=${STT_DEVICE:-cuda}
      - STT_COMPUTE_TYPE=${STT_COMPUTE_TYPE:-float16}
      # - STT_DEFAULT_MODEL=...  # deprecated, use STT_MODEL
      # ── Model Lifecycle ──
      - OS_MODEL_TTL=${OS_MODEL_TTL:-300}
      - OS_MAX_LOADED_MODELS=${OS_MAX_LOADED_MODELS:-0}
      # - STT_MODEL_TTL=...  # deprecated, use OS_MODEL_TTL
      # - STT_MAX_LOADED_MODELS=...  # deprecated, use OS_MAX_LOADED_MODELS
      # ── Streaming ──
      - OS_STREAM_CHUNK_MS=${OS_STREAM_CHUNK_MS:-2000}
      - OS_STREAM_VAD_THRESHOLD=${OS_STREAM_VAD_THRESHOLD:-0.5}
      - OS_STREAM_ENDPOINTING_MS=${OS_STREAM_ENDPOINTING_MS:-300}
      - OS_STREAM_MAX_CONNECTIONS=${OS_STREAM_MAX_CONNECTIONS:-10}
      # ── SSL ──
      - OS_SSL_ENABLED=${OS_SSL_ENABLED:-true}
      - OS_SSL_CERTFILE=${OS_SSL_CERTFILE:-}
      - OS_SSL_KEYFILE=${OS_SSL_KEYFILE:-}
      # ── Wyoming ──
      - OS_WYOMING_ENABLED=${OS_WYOMING_ENABLED:-false}
      - OS_WYOMING_HOST=${OS_WYOMING_HOST:-127.0.0.1}
      - OS_WYOMING_PORT=${OS_WYOMING_PORT:-10400}
      # ── TTS ──
      - TTS_ENABLED=${TTS_ENABLED:-true}
      - TTS_MODEL=${TTS_MODEL:-kokoro}
      - TTS_VOICE=${TTS_VOICE:-af_heart}
      - TTS_DEVICE=${TTS_DEVICE:-cuda}
      - TTS_MAX_INPUT_LENGTH=${TTS_MAX_INPUT_LENGTH:-4096}
      - TTS_SPEED=${TTS_SPEED:-1.0}
      # - TTS_DEFAULT_MODEL=...  # deprecated, use TTS_MODEL
      # - TTS_DEFAULT_VOICE=...  # deprecated, use TTS_VOICE
      # - TTS_DEFAULT_SPEED=...  # deprecated, use TTS_SPEED
      # ── Security ──
      - OS_API_KEY=${OS_API_KEY:-}
      - OS_RATE_LIMIT=${OS_RATE_LIMIT:-0}
      - OS_RATE_LIMIT_BURST=${OS_RATE_LIMIT_BURST:-0}
      - OS_MAX_UPLOAD_MB=${OS_MAX_UPLOAD_MB:-100}
      - OS_CORS_ORIGINS=${OS_CORS_ORIGINS:-*}
      - OS_TRUST_PROXY=${OS_TRUST_PROXY:-false}
      # - STT_API_KEY=...  # deprecated, use OS_API_KEY
    volumes:
      - hf-cache:/home/openspeech/.cache/huggingface
      - vad-cache:/home/openspeech/.cache/silero-vad
      - ssl-certs:/var/lib/open-speech/certs

volumes:
  hf-cache:
  vad-cache:
  ssl-certs:
