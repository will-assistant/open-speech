services:
  open-speech:
    build:
      context: .
      dockerfile: Dockerfile
    image: jwindsor1/open-speech:latest
    container_name: open-speech
    restart: unless-stopped
    ports:
      - "8100:8100"
      - "10400:10400"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    env_file:
      - path: .env
        required: false
    environment:
      # OS_* (server/shared)
      - OS_HOST=${OS_HOST:-0.0.0.0}
      - OS_PORT=${OS_PORT:-8100}
      - OS_API_KEY=${OS_API_KEY:-}
      - OS_AUTH_REQUIRED=${OS_AUTH_REQUIRED:-false}
      - OS_CORS_ORIGINS=${OS_CORS_ORIGINS:-*}
      - OS_WS_ALLOWED_ORIGINS=${OS_WS_ALLOWED_ORIGINS:-}
      - OS_TRUST_PROXY=${OS_TRUST_PROXY:-false}
      - OS_MAX_UPLOAD_MB=${OS_MAX_UPLOAD_MB:-100}
      - OS_RATE_LIMIT=${OS_RATE_LIMIT:-0}
      - OS_RATE_LIMIT_BURST=${OS_RATE_LIMIT_BURST:-0}
      - OS_SSL_ENABLED=${OS_SSL_ENABLED:-true}
      - OS_SSL_CERTFILE=${OS_SSL_CERTFILE:-}
      - OS_SSL_KEYFILE=${OS_SSL_KEYFILE:-}
      - OS_WYOMING_ENABLED=${OS_WYOMING_ENABLED:-false}
      - OS_WYOMING_HOST=${OS_WYOMING_HOST:-127.0.0.1}
      - OS_WYOMING_PORT=${OS_WYOMING_PORT:-10400}
      - OS_REALTIME_ENABLED=${OS_REALTIME_ENABLED:-true}
      - OS_REALTIME_MAX_BUFFER_MB=${OS_REALTIME_MAX_BUFFER_MB:-50}
      - OS_REALTIME_IDLE_TIMEOUT_S=${OS_REALTIME_IDLE_TIMEOUT_S:-120}
      - OS_MODEL_TTL=${OS_MODEL_TTL:-300}
      - OS_MAX_LOADED_MODELS=${OS_MAX_LOADED_MODELS:-0}
      - OS_STREAM_CHUNK_MS=${OS_STREAM_CHUNK_MS:-2000}
      - OS_STREAM_VAD_THRESHOLD=${OS_STREAM_VAD_THRESHOLD:-0.5}
      - OS_STREAM_ENDPOINTING_MS=${OS_STREAM_ENDPOINTING_MS:-300}
      - OS_STREAM_MAX_CONNECTIONS=${OS_STREAM_MAX_CONNECTIONS:-10}
      - OS_PROVIDERS_DIR=${OS_PROVIDERS_DIR:-/home/openspeech/data/providers}

      # STT_*
      - STT_MODEL=${STT_MODEL:-deepdml/faster-whisper-large-v3-turbo-ct2}
      - STT_DEVICE=${STT_DEVICE:-cuda}
      - STT_COMPUTE_TYPE=${STT_COMPUTE_TYPE:-float16}
      - STT_MODEL_DIR=${STT_MODEL_DIR:-}
      - STT_PRELOAD_MODELS=${STT_PRELOAD_MODELS:-}
      - STT_VAD_ENABLED=${STT_VAD_ENABLED:-true}
      - STT_VAD_THRESHOLD=${STT_VAD_THRESHOLD:-0.5}
      - STT_VAD_MIN_SPEECH_MS=${STT_VAD_MIN_SPEECH_MS:-250}
      - STT_VAD_SILENCE_MS=${STT_VAD_SILENCE_MS:-800}
      - STT_DIARIZE_ENABLED=${STT_DIARIZE_ENABLED:-false}
      - STT_NOISE_REDUCE=${STT_NOISE_REDUCE:-false}
      - STT_NORMALIZE=${STT_NORMALIZE:-true}

      # TTS_*
      - TTS_ENABLED=${TTS_ENABLED:-true}
      - TTS_MODEL=${TTS_MODEL:-kokoro}
      - TTS_VOICE=${TTS_VOICE:-af_heart}
      - TTS_DEVICE=${TTS_DEVICE:-cuda}
      - TTS_MAX_INPUT_LENGTH=${TTS_MAX_INPUT_LENGTH:-4096}
      - TTS_DEFAULT_FORMAT=${TTS_DEFAULT_FORMAT:-mp3}
      - TTS_SPEED=${TTS_SPEED:-1.0}
      - TTS_PRELOAD_MODELS=${TTS_PRELOAD_MODELS:-}
      - TTS_VOICES_CONFIG=${TTS_VOICES_CONFIG:-}
      - TTS_CACHE_ENABLED=${TTS_CACHE_ENABLED:-false}
      - TTS_CACHE_MAX_MB=${TTS_CACHE_MAX_MB:-500}
      - TTS_CACHE_DIR=${TTS_CACHE_DIR:-/var/lib/open-speech/cache}
      - TTS_TRIM_SILENCE=${TTS_TRIM_SILENCE:-true}
      - TTS_NORMALIZE_OUTPUT=${TTS_NORMALIZE_OUTPUT:-true}
      - TTS_PRONUNCIATION_DICT=${TTS_PRONUNCIATION_DICT:-}
      - TTS_QWEN3_SIZE=${TTS_QWEN3_SIZE:-1.7B}
      - TTS_QWEN3_FLASH_ATTN=${TTS_QWEN3_FLASH_ATTN:-false}
      - TTS_QWEN3_DEVICE=${TTS_QWEN3_DEVICE:-cuda:0}
    volumes:
      - hf-cache:/home/openspeech/.cache/huggingface
      - ./data:/home/openspeech/data
      - vad-cache:/home/openspeech/.cache/silero-vad
      - ssl-certs:/var/lib/open-speech/certs
      - tts-cache:/var/lib/open-speech/cache

volumes:
  hf-cache:
  vad-cache:
  ssl-certs:
  tts-cache:
