###############################################################################
# Open Speech — CPU only (STT + TTS)
#
# Environment variable naming convention:
#   OS_*   — Server-level settings (port, host, SSL, rate limiting)
#   STT_*  — Speech-to-text settings (model, device, compute type)
#   TTS_*  — Text-to-speech settings (model, device, voice, speed)
#
# Old STT_PORT, STT_HOST etc. still work but are deprecated.
#
# Quick start:
#   docker compose -f docker-compose.cpu.yml up -d
###############################################################################

services:
  open-speech:
    build:
      context: .
      dockerfile: Dockerfile.cpu
    image: jwindsor1/open-speech:cpu
    container_name: open-speech
    restart: unless-stopped
    ports:
      - "${OS_PORT:-8100}:${OS_PORT:-8100}"
      - "${OS_WYOMING_PORT:-10400}:${OS_WYOMING_PORT:-10400}"
    env_file:
      - path: .env
        required: false
    environment:
      # ── Server ──
      - OS_PORT=${OS_PORT:-8100}
      - OS_HOST=${OS_HOST:-0.0.0.0}
      # ── STT ──
      - STT_MODEL=${STT_MODEL:-Systran/faster-whisper-base}
      - STT_DEVICE=${STT_DEVICE:-cpu}
      - STT_COMPUTE_TYPE=${STT_COMPUTE_TYPE:-int8}
      # ── Model Lifecycle ──
      - OS_MODEL_TTL=${OS_MODEL_TTL:-300}
      - OS_MAX_LOADED_MODELS=${OS_MAX_LOADED_MODELS:-0}
      # ── Streaming ──
      - OS_STREAM_CHUNK_MS=${OS_STREAM_CHUNK_MS:-2000}
      - OS_STREAM_VAD_THRESHOLD=${OS_STREAM_VAD_THRESHOLD:-0.5}
      - OS_STREAM_ENDPOINTING_MS=${OS_STREAM_ENDPOINTING_MS:-300}
      - OS_STREAM_MAX_CONNECTIONS=${OS_STREAM_MAX_CONNECTIONS:-10}
      # ── SSL ──
      - OS_SSL_ENABLED=${OS_SSL_ENABLED:-true}
      - OS_SSL_CERTFILE=${OS_SSL_CERTFILE:-}
      - OS_SSL_KEYFILE=${OS_SSL_KEYFILE:-}
      # ── Wyoming ──
      - OS_WYOMING_ENABLED=${OS_WYOMING_ENABLED:-false}
      - OS_WYOMING_PORT=${OS_WYOMING_PORT:-10400}
      # ── TTS ──
      - TTS_ENABLED=${TTS_ENABLED:-true}
      - TTS_MODEL=${TTS_MODEL:-kokoro}
      - TTS_VOICE=${TTS_VOICE:-af_heart}
      - TTS_DEVICE=${TTS_DEVICE:-cpu}
      - TTS_MAX_INPUT_LENGTH=${TTS_MAX_INPUT_LENGTH:-4096}
      - TTS_SPEED=${TTS_SPEED:-1.0}
      # ── Security ──
      - OS_API_KEY=${OS_API_KEY:-}
      - OS_RATE_LIMIT=${OS_RATE_LIMIT:-0}
      - OS_RATE_LIMIT_BURST=${OS_RATE_LIMIT_BURST:-0}
      - OS_MAX_UPLOAD_MB=${OS_MAX_UPLOAD_MB:-100}
      - OS_CORS_ORIGINS=${OS_CORS_ORIGINS:-*}
      - OS_TRUST_PROXY=${OS_TRUST_PROXY:-false}
    volumes:
      - hf-cache:/root/.cache/huggingface
      - vad-cache:/root/.cache/silero-vad
      - ssl-certs:/tmp/open-speech-certs

volumes:
  hf-cache:
  vad-cache:
  ssl-certs:
