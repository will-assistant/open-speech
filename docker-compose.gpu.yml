###############################################################################
# Open Speech — GPU accelerated (STT + TTS)
#
# Quick start:
#   docker compose -f docker-compose.gpu.yml up -d
#
# Requires: NVIDIA GPU + nvidia-container-toolkit
#
# Web UI:  https://localhost:8100/web
# STT:     POST https://localhost:8100/v1/audio/transcriptions
# TTS:     POST https://localhost:8100/v1/audio/speech
###############################################################################

services:
  open-speech:
    build:
      context: .
      dockerfile: Dockerfile
    image: jwindsor1/open-speech:latest
    container_name: open-speech
    restart: unless-stopped
    ports:
      - "${STT_PORT:-8100}:${STT_PORT:-8100}"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    env_file:
      - path: .env
        required: false
    environment:
      # ── Server ──
      - STT_PORT=${STT_PORT:-8100}
      - STT_HOST=${STT_HOST:-0.0.0.0}
      # ── STT ──
      - STT_DEVICE=${STT_DEVICE:-cuda}
      - STT_COMPUTE_TYPE=${STT_COMPUTE_TYPE:-float16}
      - STT_DEFAULT_MODEL=${STT_DEFAULT_MODEL:-deepdml/faster-whisper-large-v3-turbo-ct2}
      - STT_PRELOAD_MODELS=${STT_PRELOAD_MODELS:-deepdml/faster-whisper-large-v3-turbo-ct2}
      # ── STT Lifecycle ──
      - STT_MODEL_TTL=${STT_MODEL_TTL:-300}
      - STT_MAX_LOADED_MODELS=${STT_MAX_LOADED_MODELS:-0}
      # ── STT Streaming ──
      - STT_STREAM_CHUNK_MS=${STT_STREAM_CHUNK_MS:-2000}
      - STT_STREAM_VAD_THRESHOLD=${STT_STREAM_VAD_THRESHOLD:-0.5}
      - STT_STREAM_ENDPOINTING_MS=${STT_STREAM_ENDPOINTING_MS:-300}
      - STT_STREAM_MAX_CONNECTIONS=${STT_STREAM_MAX_CONNECTIONS:-10}
      # ── TTS ──
      - TTS_ENABLED=${TTS_ENABLED:-true}
      - TTS_DEFAULT_MODEL=${TTS_DEFAULT_MODEL:-kokoro}
      - TTS_DEFAULT_VOICE=${TTS_DEFAULT_VOICE:-af_heart}
      - TTS_DEVICE=${TTS_DEVICE:-cuda}
      - TTS_MAX_INPUT_LENGTH=${TTS_MAX_INPUT_LENGTH:-4096}
      - TTS_DEFAULT_FORMAT=${TTS_DEFAULT_FORMAT:-mp3}
      - TTS_DEFAULT_SPEED=${TTS_DEFAULT_SPEED:-1.0}
      - TTS_PRELOAD_MODELS=${TTS_PRELOAD_MODELS:-}
      - TTS_VOICES_CONFIG=${TTS_VOICES_CONFIG:-}
      # ── Security ──
      - STT_API_KEY=${STT_API_KEY:-}
      - STT_RATE_LIMIT=${STT_RATE_LIMIT:-0}
      - STT_RATE_LIMIT_BURST=${STT_RATE_LIMIT_BURST:-0}
      - STT_MAX_UPLOAD_MB=${STT_MAX_UPLOAD_MB:-100}
      - STT_CORS_ORIGINS=${STT_CORS_ORIGINS:-*}
      - STT_TRUST_PROXY=${STT_TRUST_PROXY:-false}
    volumes:
      - hf-cache:/root/.cache/huggingface
      - vad-cache:/root/.cache/silero-vad

volumes:
  hf-cache:
  vad-cache:
