###############################################################################
# Open Speech — Default Docker Compose (STT + TTS)
#
# Environment variable naming convention:
#   OS_*   — Server-level settings (port, host, SSL, rate limiting)
#   STT_*  — Speech-to-text settings (model, device, compute type)
#   TTS_*  — Text-to-speech settings (model, device, voice, speed)
#
# Old STT_PORT, STT_HOST etc. still work but are deprecated.
#
# Quick start:
#   docker compose up -d
#
# Web UI:  https://localhost:8100/web
# STT:     POST https://localhost:8100/v1/audio/transcriptions
# TTS:     POST https://localhost:8100/v1/audio/speech
# Docs:    https://localhost:8100/docs
###############################################################################

services:
  open-speech:
    image: jwindsor1/open-speech:cpu
    container_name: open-speech
    restart: unless-stopped
    ports:
      - "8100:8100"
      - "10400:10400"
    env_file:
      - path: .env
        required: false
    environment:
      # ── Server ──
      - OS_PORT=8100
      - OS_HOST=0.0.0.0
      # - STT_PORT=8100  # deprecated, use OS_PORT
      # - STT_HOST=0.0.0.0  # deprecated, use OS_HOST
      # ── STT ──
      - STT_MODEL=Systran/faster-whisper-base
      - STT_DEVICE=cpu
      - STT_COMPUTE_TYPE=int8
      # - STT_DEFAULT_MODEL=...  # deprecated, use STT_MODEL
      # ── SSL ──
      - OS_SSL_ENABLED=${OS_SSL_ENABLED:-true}
      - OS_SSL_CERTFILE=${OS_SSL_CERTFILE:-}
      - OS_SSL_KEYFILE=${OS_SSL_KEYFILE:-}
      # ── Wyoming ──
      - OS_WYOMING_ENABLED=${OS_WYOMING_ENABLED:-false}
      - OS_WYOMING_PORT=${OS_WYOMING_PORT:-10400}
      # ── TTS ──
      - TTS_ENABLED=true
      - TTS_MODEL=kokoro
      - TTS_VOICE=af_heart
      - TTS_DEVICE=cpu
      # - TTS_DEFAULT_MODEL=...  # deprecated, use TTS_MODEL
      # - TTS_DEFAULT_VOICE=...  # deprecated, use TTS_VOICE
    volumes:
      - hf-cache:/root/.cache/huggingface
      - vad-cache:/root/.cache/silero-vad
      - ssl-certs:/tmp/open-speech-certs

volumes:
  hf-cache:
  vad-cache:
  ssl-certs:
